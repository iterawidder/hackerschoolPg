<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" type="text/css" href="./css/materialize.css" media="screen,projection"/>
    <script src="./lib/lodash.js"></script>
    <script src="./lib/handlebars.js"></script>
    <script src="./lib/jquery-3.1.1.js"></script>
    <script src="./lib/languageName.js"></script>

    <title>Voices</title>

</head>
<body>

<h1>Installed Voices in Browser</h1>

    <script id="voices-table-script" type="text/x-handlebars-template">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Country</th>
                <th>Native country name (click to here the name spoken)</th>
                <th>Type in some text ...</th>
                <th>... and try it!</th>
            </tr>
            </thead>

            <tbody>
            {{#each voices}}
                <tr>
                    <td>
                        {{@index}}
                    </td>
                    <td>
                        {{name}}
                    </td>
                    <td>
                        {{languageName}}
                    </td>
                    <td>
                        <a onclick="speekText('{{languageNativeName}}', {{@index}})" class="btn">{{languageNativeName}}</a>
                    </td>
                    <td>
                        <input placeholder="Some text to speak" id="i-{{@index}}" type="text" class="validate">
                    </td>
                    <td>
                        <a onclick="speekInput({{@index}})" class="btn">Try it!</a>
                    </td>
                </tr>
            {{/each}}
            </tbody>
        </table>
    </script>

    <div id="voices-table"></div>

    <script>
        /* global $ */
        /* global _ */
        /* global Handlebars */
        /* global window */

        var speekText = function (text, voiceNum) {
            var msg = new SpeechSynthesisUtterance(text);
            var voices = window.speechSynthesis.getVoices();
            msg.voice = voices[voiceNum];
            window.speechSynthesis.speak(msg);
        };

        var speekInput = function(voiceNum) {
            var text = $("#i-" + voiceNum).val();
            speekText(text, voiceNum);
        };

        $(function () {
            function listVoices() {
                var voices = window.speechSynthesis.getVoices();
                if(_.isEmpty(voices)) {
                    $("#voices-table").html("Waiting for voices ...");
                    setTimeout(listVoices, 1000);
                }
                else {
                    voices.forEach(function (voice) {
                        var lang = voice.lang.split('-')[0];
                        voice.languageName = window.getLanguageName(lang);
                        voice.languageNativeName = window.getLanguageNativeName(lang);
                    });

                    $("#voices-table").empty();
                    var templateScript = $("#voices-table-script").html();
                    var template = Handlebars.compile(templateScript);
                    var ctx = {
                        voices: voices
                    };
                    var html = template(ctx);
                    $("#voices-table").append(html);
                }
            }

            listVoices();
        });
    </script>
</table>
</body>
</html>